实现接口幂等性会消耗一定的资源，一般查询和删除操作不需要幂等判断。

# token机制

1. 调用获取 token 接口，服务端将 token 保存在 redis 中
2. 调用业务接口，服务端判断 token 是否在 redis 中，如果存在，表示第一次请求，删除 token，执行业务；如果不存在，表示重复操作，不执行业务操作。

**关键点是，先删除 token，还是后删除 token**

- 后删除 token：如果业务执行成功，但是删除 token 失败了，就很有可能导致重复请求。
- 先删除 token：先删除 token，如果之后执行业务失败了，可以返回用户业务执行失败。因为 token 已经删除了，所以可以重新请求 token 接口后，再请求业务接口。

但是每次业务请求都会有额外的请求，而实际的场景中，多次提交的比例可能没有那么大，就会造成资源浪费。

# 乐观锁

在建表时，添加 version 字段，每次 SQL 操作时，带上 version 字段，确保相同SQL执行结果不受次数影响。多用在 update 操作上。

# 唯一索引

在执行插入操作时，设置唯一字段是业务ID，比如说订单服务的订单ID，重复插入会导致插入失败，于是如果插入失败了就可以判定为重复提交。

# 唯一ID

调用接口时，在客户端生成一个唯一ID，redis 将数据保存在集合中，如果有重复的说明处理过了。





# 结果

最终采用使用唯一ID的方式，更加简单有效。

## 详细过程

采用唯一ID是 uuid，即使在分布式的环境下，也可以保证唯一。

https://www.jianshu.com/p/e618cc818432

https://segmentfault.com/a/1190000020172463