# 班车服务

## 场次

方法：`getCount` , `getCountDetailById`。

主要是获取符合要求的场次，如日期时间、状态。使用的是 mybatis 的分页插件。

调用方法时，首先在 redis 上查询，key 为 getCount、班车状态和当前页面的合并字符串，存在就直接返回 redis 数据，不存在就在数据库用mybatis的分页插件查询，并插入redis。同时检查 redis 中的总页数是否变化，key 为 getCount、班车状态的合并字符串，有变化就更新redis。

## 座位

### 判断座位是否重复

方法：`repeatSeats`

前端传参为，选中的座位并以逗号隔开的字符串。将从数据库查出的该班车已占座位放入 `hashSet` ，并遍历用户选中的座位号，调用 `hashSet` 的 `contains`方法判断是否有重复。

**这里可能有并发问题**。

因为如果多个用户选座位时，

### 添加占座

方法：`addSeats`

主要是通过字符串拼接完成添加占座功能。

### 回退座位

方法：`filterRepeatSeats`

前端传入需要回退的座位号和场次号，和判断座位是否重复类似，将已经占座的座位号放入 `hashSet`，遍历判断回退座位号，并调用 `hashSet`的`remove`方法删除。

# 定时器

## 修改状态

使用 `springboot` 的 `@Scheduled` 注解实现，每三十分钟修改场次的状态，对数据库进行操作。

这里有改进的空间，因为每三十分钟就需要进行扫库执行IO，很消耗性能。可以使用 redis 的延迟队列 zset，元素为场次ID，元素对应的score为出发时间，采用定时器，每半小时取出队列中**当前时间大于队列中权重的场次ID**，修改状态。

## 添加场次

项目中没有后台，使用定时器，每天凌晨重置场次。