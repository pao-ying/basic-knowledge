主要是在**添加订单**，**支付**和**回退**的时候采用了MQ中间件。目的是在系统发生异常时，能够保持系统的一致性。

# 添加订单

在添加订单时，会有几个环节，判断**座位是否重复、添加占座、计算金额、添加订单和添加未支付订单redis缓存**。在这些环节中如果出现问题，则发送“订单添加异常”的消息到MQ中。

消费者收到消息时，**判断消息类型**，如果是作为异常，则调用 `orderSeatsCancleListener` 即**回退座位**的 `onMessage` 回调函数；如果是订单异常，则调用 `orderAddCancleListener`即**取消订单**的`onMessage`回调函数。

- 回退座位，Redis保持幂等性，判断Redis中 key 是否存在，判断场次ID和对应座位是否存在，再调用业务中的回退座位的方法。
- 取消订单，Redis保持幂等性，判断Redis中 key 是否存在，判断订单ID是否存在，再调用业务中的取消订单方法。

# 支付

在支付环节，进过几个环节