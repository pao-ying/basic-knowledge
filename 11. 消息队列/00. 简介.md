# 简介

消息队列看作是一个存放消息的容器，当我们需要使用消息的时候，直接从容器中取出消息供自己使用即可。队列 Queue 是一种先进先出的数据结构，所以消费消息时也是按照顺序来消费的。

## 为什么使用

1. **异步、通过异步处理提高系统性能（减少响应所需时间）。**

   处理如短信下发、状态推送、用户注册、数据同步等功能，提高系统的并发能力，集中力量处理重要的部分（同步处理），将非核心功能丢给MQ。

2. **削峰/限流**

   对于秒杀场景下的下单处理。服务器收到消息后，首先写入消息队列，然后按照自己的消息处理能力做处理。

3. **解耦、降低系统耦合性。**

   可在模块、服务、接口等不同粒度上实现解耦。生产者（客户端）发送消息到消息队列中去，接受者（服务端）处理消息，需要消费的系统直接去消息队列取消息进行消费即可而不需要和其他系统有耦合，这显然也提高了系统的扩展性。

4. **重试补偿**

   在跨机器数据传输的整个过程中，只要任意一个环节出错，都会导致问题的产生。可以通过MQ的重试补偿机制去尽可能的处理掉这些异常。

5. **日志处理**

   可以定时将日志写入MQ，并且主动订阅日志记录。

## 消息队列的问题

- **系统可用性降低：** 系统可用性在某种程度上降低。在加入 MQ 之前，你不用考虑**消息丢失或者说 MQ 挂掉**等等的情况，但是，引入 MQ 之后你就需要去考虑了！
- **系统复杂性提高：** 加入 MQ 之后，你需要**保证消息没有被重复消费、处理消息丢失的情况**、保证**消息传递的顺序性**等等问题！
- **一致性问题：** 我上面讲了消息队列可以实现异步，消息队列带来的异步确实可以提高系统响应速度。但是，**万一消息的真正消费者并没有正确消费消息怎么办**？这样就会导致数据不一致的情况了!

# 核心概念

1. 消息服务器 Broker

   作为server提供消息核心服务

2. 消息生产者 Producer

   发送消息到消息队列

3. 消息消费者 Consumer

   从消息队列中接收消息

4. 消息队列 Queue

   一个先进先出的消息存储区域。消息按照顺序发送接收，一旦消息被消费处理，该消息将从队列中删除。

   - 本地队列

     按功能划分

     - 初始化队列：用作消息触发功能
     - 传输队列：是暂存待传的消息，条件许可的情况下，通过管道将消息传送到其他的队列管理器。
     - 目标队列：是消息的目的地，可以长期存放消息。
     - 死信队列：如果消息不能送达目标队列，也不能再路由出去，则被自动放入死信队列保存。

   - 别名队列&远程队列

     是一个队列定义，用来指定远端队列管理器的队列。使用了远程队列，程序就不需要知道目标队列的位置。

   - 模型队列

     模型队列定义了一套本地队列的属性结合，一旦打开模型队列，队列管理器会按照这些属性动态地创建出一个本地队列。

5. 主题 Topic

   发布订阅模式下的消息统一汇集地，不同生产者向topic发送消息，由MQ服务器分发到不同的订阅者，实现消息的消费

6. 消息体 Message

# 消息模式

## PTP点对点

- 每个消息只有一个消费者（Consumer）(即一旦被消费，消息就不再在消息队列中)
- 发送者和接收者之间在时间上没有依赖性
- 接收者在成功接收消息之后需向队列应答成功
- 利用FIFO先进先出的特性，可以保证消息的顺序性。

## Pub/Sub发布订阅

- 每个消息可以有多个消费者：和点对点方式不同，发布消息可以被所有订阅者消费
- 发布者和订阅者之间有时间上的依赖性。
- 针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息。
- 为了消费消息，订阅者必须保持运行的状态。

# 常用协议

只要是通信，就会用到协议

## AMQP

AMQP即Advanced Message Queuing Protocol，是应用层协议的一个开放标准，为面向消息的中间件设计。消息中间件主要用于组件之间的解耦，消息的发送者无需知道消息使用者的存在，反之亦然。AMQP是二进制协议，主要特征是**面向消息、队列、路由（包括点对点和发布/订阅）**。

应用场景：当简单的发布－订阅模型不能满足使用要求。

优点：可靠、通用

## STOMP

STOMP（Streaming Text Orientated Message Protocol）是流文本定向消息协议，是一种为MOM(Message Oriented Middleware，面向消息的中间件)设计的简单文本协议。STOMP提供一个可互操作的连接格式，允许客户端与任意STOMP消息代理（Broker）进行交互，通常作用于**发布－订阅**的模型。

应用场景：信息交换基于文本，要求简单的场景。

优点：命令模式（非topic\queue模式）

## XMPP

XMPP（可扩展消息处理现场协议，Extensible Messaging and Presence Protocol）是基于可扩展标记语言（XML）的协议，多用于即时消息（IM）以及在线现场探测。适用于服务器之间的准即时操作。核心是基于XML流传输，这个协议可能最终允许因特网用户向因特网上的其他任何人发送即时消息，即使其操作系统和浏览器不同。**但XML编码格式占用带宽大**。

应用场景：尽可能的简化客户端，复杂的都放在服务端。

优点：通用公开、兼容性强、可扩展、安全性高

## JMS

JMS是基于JVM消息代理的规范,是对AMQP，MQTT，STOMP，XMPP等协议更高一层的抽象。JMS是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。

应用场景：在java体系中，多个服务可以通过JMS进行交互，不需要应用修改代码，但是其对跨平台的支持较差。

优点：异步、可靠
