# SSL连接

SSL全名`Secure Sockets Layer`，即安全套接层协议层。SSL协议指定了一种在应用程序协议（如http, telenet, nmtp和ftp等）和TCP/IP协议之间**提供数据安全性分层机制**。

# HTTP和HTTPS

- http使用端口是80，https使用的端口是443.
- http协议是运行在tcp协议之上，https是运行在TCP + SSL协议之上。
- http是进行明文传输的，而https会**对传输的内容进行加密，并且可以互相验证身份**。

```
SSL协议指定了一种在应用层协议，如http, telenet, nmtp, ftp等和TCP/IP协议之间提供数据安全性分层的机制。
```

# HTTP 版本

## HTTP1.0：

- 浏览器与服务器只保持短暂的连接，浏览器的每次请求都需要与服务器建立一个TCP连接

## HTTP1.1：

- 引入了持久连接，即TCP连接默认不关闭，可以被多个请求复用

  `Connection: keep-alive`

- 在同一个TCP连接里面，客户端可以同时发送多个请求

- 虽然允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的，服务器只有处理完一个请求，才会接着处理下一个请求。如果前面的处理特别慢，后面就会有许多请求排队等着

- 新增了一些请求方法 put, delete, options

- 新增了一些请求头和响应头

## HTTP2.0：

- 采用二进制格式而非文本格式

- 完全多路复用，而非有序并阻塞的、只需一个连接即可实现并行

  > `HTTP/2` 复用`TCP`连接，在一个连接里，客户端和浏览器都可以**同时**发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了”队头堵塞”

- 使用报头压缩，降低开销

- 服务器推送，允许服务端推送资源给客户端

  > 服务器会顺便把一些客户端需要的资源一起推送到客户端，如在响应一个页面请求中，就可以随同页面的其它资源一起返回，免得客户端再次创建连接发送请求到服务器端获取，这种方式非常合适加载静态资源

# SSL/TLS协议

- 客户端发送请求
- 服务端将证书发给客户端
- 客户端会对证书进行检查，查看是否是可信任的机构颁布的，或者域名是否对等，是否过期等。如果证书没有问题，则客户端从证书中取出服务器的公钥，并对传输的数据进行加密。
- 服务端再使用私钥对传输的数据进行解密。

# 报文结构

## request

- 第一部分是**请求行**

  包含：**请求方式、请求地址、请求协议版本**

- 第二部分是**请求头部**

  ```
  User-Agent: ...
  Host: ...
  ```

- 第三部分是**请求体**，但只有POST请求有

## response

- **状态行**

  包含：**协议、响应码（状态码）、状态码描述**

- 响应头部

- **响应正文**

# HTTP工作流程

1. 地址解析

   通过标准的URL来请求指定服务器中指定的服务

2. 封装HTTP请求

   将URL和本机信息封装在HTTP请求包上

3. 封装TCP包

   封装TCP包,建立TCP连接

4. 客户端向服务器发送 HTTP 请求

5. 服务器端响应 HTTP 请求，客户端得到 HTML 代码

6. 浏览器解析 HTML 代码，并请求 HTML 代码中的资源

7. 关闭 TCP 连接，浏览器对页面进行渲染呈现给用户

# HTTP协议与TCP/IP协议关系

HTTP 是应用层协议，TCP 是传输层协议，IP 是网络层协议。

IP 协议主要是解决网络路由和寻址问题，TCP 协议主要解决在 IP 层指上可靠的传输数据报

# 长连接/短连接

## TCP 短连接

client 向 server 发起连接请求，server 接收到请求后双方建立连接。当一次请求完成之后，发起 closed 请求，关闭连接。

## TCP 长连接

`Keep-Alive`

client 向 server 发起连接请求，server 接收到请求后双方建立连接。但是当双方完成一次请求之后，它们之间的连接不会主动关闭，后续的操作还会继续使用这个连接。

使用 TCP 保活计时器可以验证客户端的状态。假定给定连接 2 小时内无动作，则服务器向客户端发送探测报文，则客户端会有以下状态：

- 客户端响应正常，则保活计时器复位
- 客户端不能响应，则服务器总共发送 10 次探测报文，每个间隔 75 秒，如果没有任何一个响应，则关闭连接。

### 守护进程

**Httpd守护进程**，一般都提供了**keep-alivetimeout**时间设置参数。一个http产生的tcp连接在传送完最后一个响应后，还需要hold住 keepalive_timeout秒后，才开始关闭这个连接。如果守护进程在这个等待的时间里，一直没有收到浏览发过来http请求，则关闭这个http连接。

# Keep-Alive

## HTTP Keep-Alive

在HTTP 1.0以前，每个http请求都要求打开一个**TCP socket连接**，并且使用一次之后就断开这个TCP连接，这会导致频繁地创建和销毁TCP。HTTP 1.1通过使用keep-alive可以改善这种状态，即在一次TCP连接中可以持续发送多份数据而不会断开连接。

## TCP Keep-Alive

这是TCP协议栈为了**检测连接状况的保活机制**，当TCP空闲一定时间后会发送心跳包给对方，如果对端回复ACK后，就认为对端是存活的，重置定时器；如果对端回复RST应答（对端崩溃或者其他原因，导致的复位），那就关闭该连接；如果对端无任何回应，那就会出发超时重传，**直到达到重传的次数**，如果对端依然没有回复，那么就关闭该连接。

# http 是无状态的

> 无状态是指下一次传输可以“记住”这次传输信息的能力

- 同一个 URL 请求没有上下文关系
- 每次请求都是独立的，和之前、之后的都没有直接关系
- 服务器没有保存客户端状态，每次请求都需要带上客户端的状态。

# socket/http

HTTP 协议对应于应用层，是基于 `TCP/IP` 协议的。而 `socket` 是对 `TCP/IP` 协议的封装，Socket 本身并不是协议，而是一个调用接口，通过 `socket` ，才可以调用 `TCP/IP` 协议。

## http 连接

HTTP 连接的特点就是客户端发送的请求都需要服务器响应，在请求结束后，会主动释放连接，从建立连接到释放连接的过程称之为“一次连接”。

## socket连接

socket 是通信的基石，是支持 `TCP/IP` 协议网络通信的基本单元。包含有：连接协议、本地 IP、本地协议端口、远程 IP、远程协议端口。

`socket` 连接需要两个一对套接字，一个位于客户端 `clientSocket`，一个位于服务端 `serverSocket`。

`socket` 连接三步骤：服务器监听、客户端请求、连接确认。

- 服务端监听

  服务端套接字负责监听，等待客户端的请求连接

- 客户端请求

  客户端套接字提出连接请求，指出服务端的 IP 地址和对应端口，向服务端套接字发出请求。

- 连接确认

  当服务端套接字接收到客户端请求时，就响应客户端套接字请求，建立一个新的进程。

# HTTP服务器模块

1. soket 连接，监听某个端口
   1. 建立服务端和客户端之间的连接
   2. 从 socket 读数据
   3. 从 socket 写数据
2. 解析 http 请求
3. 生成 http 响应
4. 将响应写回给客户端
