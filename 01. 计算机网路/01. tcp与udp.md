# TCP与UDP

## TCP头部

![ip头部结构](..\img\o_tcp头部2.jpg)

### 字段大小

TCP 头部共 20 个字节。

- 源端口号 16bit，目标端口号 16bit
- 序列号 32bit，确认号 32bit
- 头部长度 4bit，保留 6bit，标志位 6bit，窗口大小 16 bit
- 校验和 16bit，紧急数据偏移量 16bit
- 可选项、数据 32bit

### 字段说明

- 顺序号：用来标识从 TCP 源端向 TCP 目标端发送的数据字节流，他表示这个报文段的第一个数据字节。

- 确认号：只有 ACK 为1时，确认号字段才有效。它包含目标端所期望收到源端的下一个数据字节。

- **标志位字段**：

  URG: 紧急指针有效、ACK: 确认序号有效、PSH: 接收方应该尽快将这个报文交给应用层、RST: 重建连接、SYN: 发起一个连接、FIN: 释放一个连接。

- 窗口大小字段：此字段用来进行**流量控制**，代表期望一次接收的字节数

- 校验和：对整个报文段，即 TCP 头部和 TCP 数据进行校验和计算，并由目标端进行验证。

- 紧急指针：偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号

- 选项字段：可能包括窗口扩大因子、时间戳等选项。

## UDP头部

UDP 头部共 8 个字节

![udp头部定义](..\img\o_udp头部2.jpg)

### 字段大小

- 源端口号、目标端口号 16 bit
- 长度、校验和 16bit
- 数据 32bit

## 区别

- TCP 建立连接，UDP 不建立连接

- UDP 尽最大可能交付，不保证可靠交付。

  > ping 命令就是向对方主机发送 UDP 数据包

- 对系统的资源消耗，TCP多，UDP少

- TCP 保证数据顺序，UDP 不保证

# TCP保证可靠性

## 校验和

发送方在发送数据前进行校验和运算，并进行填充。

接收方在接收到数据后也进行校验和运行，并且与发送方的进行对比。

```
计算方式是：将发送的数据段相加，并且将前面的进位补在后面，最后取反，得到检验和。
```

## 序列号

TCP传输时，将每个字节都进行了编号，这就是序列号。

## ARQ协议

即**自动重传请求**，错误纠正协议之一。使用**确认**和**超时**两种机制，在不可靠服务的基础上实现可靠的信息传输。

### 确认应答(停止等待ARQ协议)

每次发送完一个分组之后就会**停止发送**，等待接收方确认，如果在一段时间后没有收到确认，则会认为没有发送成功，会继续重新发送这个分组，直到收到确认才会发送下一个分组，如果接收方收到重复的分组，则会丢失这个分组，同时重新发送确认。

- 发送无差错情况

  发送方发送，接收方在规定时间接收，并回复确认

- 发送有差错情况

  A发送数据报过程中出现了差错，但是B接收后发现该数据报出现了差错，则直接丢弃。
  
  而A在一定时间后没有收到确认，则会重新上传刚刚发送的数据报，称作**超时重传**。
  
- 确认丢失和确认延迟

  当接收方返回的确认ACK数据报丢失时，A会进行超时重传，重新上传数据报。则接收方会丢弃该数据报，因为已经接受过了，同时向A发送确认。

  当接收方返回的确认ACK延迟了，A会**直接丢弃重复的确认数据报**。

### 连续ARQ协议

连续ARQ协议可以提高信道利用率。发送方维护一个**滑动窗口**，意义在于该滑动窗口内的分组可以连续发送出去而不需等待对方的回应，提高了**信道利用率**。

连续ARQ协议规定，发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置，接收方不必对收到的分组逐个发送确认，对**按序到达的最后一个分组**发送确认。

**Go-Back-N**

即发送多个分组后，若只对前几个分组进行了接收而后面的分组丢失了，则只会返回对前几个分组的确认，而发送端必须要对后几个分组进行重新发送，即**回退n**。

## 连接管理

三次握手和四次挥手

## 流量控制

**发送端的发送速度和接收端的接收处理速度并不相同**，这就导致可能接收端的**接收缓冲区**被装满了，导致后来发送的数据无法进行应答。则**TCP根据接收端对数据的处理能力，决定发送端的发送速度**，就是流量控制。

在TCP协议的报头信息中，有一个16位的窗口信息，这个窗口信息就代表着接收端中接收缓冲区的**剩余大小**，在接收端确认应答返回ACK报文时会将自己的窗口信息填入。

## 滑动窗口

发送端的滑动窗口有四个概念：

- 已发送且接收方已确认

- 已发送但接收方未确认（发送方滑动窗口）
- 未发送但允许发送（发送方滑动窗口）

- 不可发送

接收端分为三个部分：

- 已发送确认
- 允许接受（接收方滑动窗口）
- 不允许接收

当发送端接受到ACK报文时，获取其中的序列号，意思就是下一个字节的位置，则发送端滑动窗口滑动到对应的字节位置，同时获取ACK报文中接收端的窗口大小，调整发送端滑动窗口的大小。

规则：

- 发送方已经发送的数据，在未收到确认前必须**保留**，作为超时重传使用。
- 发送方只有在接收到了确认报文后，才可以向后滑动几个序号。
- 发送方中若发送的数据一段时间后没有收到确认，即超时，则使用**回退N**协议，滑动窗口内的滑动指针回到上一次接收确认报文的位置。

## 拥塞控制

在某段时间，若**对网络中某种资源的需求超过了该资源所能提供的部分，网络性能就会变坏**，这种情况叫做**网络拥塞**。

发送方维护一个**拥塞窗口cwnd**的状态变量，维护一个**慢开始门限ssthresh**状态变量，同发送方将拥塞窗口作为发送窗口。

- 慢开始

  发送方在发送一个数据报后，收到了确认报文，则将拥塞窗口值+1。当拥塞窗口大小和**慢开始门限**相同时，改用**拥塞避免**算法。

  慢开始阶段是指向网络中注入的报文段少，而不是窗口增长速度慢，实际上慢开始窗口增长速度是**指数型的**。

- 拥塞避免

  每个**传输轮次**，拥塞窗口只会**线性加一**。

  > 当发生超时重传时，又会从拥塞避免转为慢开始，同时更改窗口大小变为 1 且门限大小变为原窗口的一半，执行慢开始，而实际上可能并没有发生网络拥堵，所以采用快速重传和快恢复。

- 快速重传

  要求接收方接受到一个**失序的报文段**后立即发出上一个接收的数据报的确认报文，同时若发送方一连收到三个重复确认就应该立即重传下一个报文段，而**不等待超时重传**。

  ![在这里插入图片描述](..\img\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxMzg2MzAw,size_16,color_FFFFFF,t_70)

- 快恢复

  若发生了快速重传，不使用慢开始，而是使用快恢复，即**慢开始门限减半，同时拥塞窗口设置为慢开始门限减半后的数值**，执行拥塞避免算法。

## 相关链接

https://blog.csdn.net/liuchenxia8/article/details/80428157

# udp保证可靠性

udp 是一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。可靠性由上层应用实现，所以要实现 udp 可靠性传输，必须通过应用层来实现和控制。

UDP它不属于连接型协议，因而具有资源消耗小，处理速度快的优点，所以通常**音频、视频和普通数据在传送时使用UDP较多**，因为它们即使偶尔丢失一两个数据包，也不会对接收结果产生太大影响。

所以需要**应用层**模拟传输层 TCP 的可靠传输，如：

- 添加 **seq/ack** 机制，确保数据发送到对端
- 添加**发送和接收缓冲区**，用于超时重传
- 添加**超时重传**机制

详细说明：

发送端发送数据时，生成一个随机seq=x，然后每一片按照数据大小分配seq。数据到达接收端后接收端放入缓存，并发送一个ack=x的包，表示对方已经收到了数据。发送端收到了ack包后，删除缓冲区对应的数据。时间到后，定时任务检查是否需要重传数据。

目前有 **RUDP, RTP, UDT** 利用 udp 实现了可靠的数据传输。

## RUDP

**RUDP 提供一组数据服务质量增强机制，如拥塞控制的改进、重发机制及淡化服务器算法等**，从而在包丢失和网络拥塞的情况下， RTP 客户机（实时位置）面前呈现的就是一个高质量的 RTP 流。在不干扰协议的实时特性的同时，可靠 UDP 的拥塞控制机制允许 TCP 方式下的流控制行为。

## RTP

**RTP为数据提供了具有实时特征的端对端传送服务**，如在组播或单播网络服务下的交互式视频音频或模拟数据。

应用程序通常在 UDP 上运行 RTP 以便使用其多路结点和校验服务；这两种协议都提供了传输层协议的功能。但是 RTP 可以与其它适合的底层网络或传输协议一起使用。如果底层网络提供组播方式，那么 RTP 可以使用该组播表传输数据到多个目的地。

RTP 本身并没有提供按时发送机制或其它服务质量（QoS）保证，它依赖于底层服务去实现这一过程。 RTP 并不保证传送或防止无序传送，也不确定底层网络的可靠性。 RTP 实行有序传送， RTP 中的序列号允许接收方重组发送方的包序列，同时序列号也能用于决定适当的包位置，例如：在视频解码中，就不需要顺序解码。

## UDT

基于UDP的数据传输协议（UDP-basedData Transfer Protocol，简称UDT）是一种互联网数据传输协议。**UDT的主要目的是支持高速广域网上的海量数据传输**，而互联网上的标准数据传输协议TCP在高带宽长距离网络上性能很差。

顾名思义，UDT建于UDP之上，并引入新的拥塞控制和数据可靠性控制机制。UDT是面向连接的双向的应用层协议。它同时支持可靠的数据流传输和部分可靠的数据报传输。由于UDT完全在UDP上实现，它也可以应用在除了高速数据传输之外的其它应用领域，例如点到点技术（P2P），防火墙穿透，多媒体数据传输等等。

