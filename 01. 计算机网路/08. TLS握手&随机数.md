![img](..\img\SSL-TLS-handshake.png)

## TLS 握手

### 1. 客户端发出请求

客户端（通常是浏览器）先向服务器发出加密通信的请求

> (1) 支持的协议版本，如TLS 1.0版本。
> (2) 一个客户端生成的随机数，稍后用于生成”**会话密钥**”。
> (3) 支持的加密方法，如RSA公钥加密。
> (4) 支持的压缩方法。

### 2. 服务器回应

服务器收到客户端请求后，向客户端发出回应。

> (1) 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
> (2) 一个服务器生成的随机数，稍后用于生成”会话密钥”。
> (3) 确认使用的加密方法，如RSA公钥加密。
> (4) **服务器证书**。

### 3. 客户端回应

验证服务器证书：

1. 是否可信赖机构颁布
2. 证书中的域名与实际域名是否一致
3. 证书是否过期

若证书无问题，则从证书中取出**公钥**。然后向服务器发送：

> (1) 一个随机数。该随机数用服务器公钥加密，防止被窃听。
> (2) 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
> (3) 客户端握手结束通知，表示客户端的握手阶段已经结束。本项的值为前面发送的所有内容的hash值，用于服务器校验，以防被篡改。

#### 使用三个随机数的意义

第三个随机数又叫做 **premaster secrect**。premaster secrect t的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么premaster secret就有可能被猜出来。

那么仅使用premaster secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上premaster secret三个随机数一同生成的密钥就不容易被猜出了。

### 4. 服务器回应

服务器收到客户端的第三个随机数premaster secret之后，计算本次会话所需的”**会话密钥**”。
然后，向客户端发送以下信息：

> (1) 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
> (2) 服务器握手结束通知，表示服务器的握手阶段已经结束。本项的值为前面发送的所有内容的hash值，用于服务器校验，以防被篡改。

至此，整个握手阶段全部结束。
接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用”会话密钥”加密内容。

## 随机数

1. 客户端产生一个随机数A，以明文方式发给服务器。
2. 服务器产生一个随机数B，以明文方式发给客户端。此外，服务器还将公钥放入证书中发送给客户端。
3. 此时客户端拥有随机数A，B以及证书（公钥）。服务器拥有随机数A，B以及其私钥。
4. 客户端产生一个随机数C，使用公钥加密，发送给服务器，服务器以私钥解密，得到随机数C。此过程使用公钥加密法（非对称加密）。
5. 此时客户端和服务器使用三个随机数A，B，C，生成相同的成对的”会话密钥”。
6. 此后，客户端和服务器端进行通信采用”会话密钥”进行加密通信（对称加密），可以减少加解密时间，提高通信速度。