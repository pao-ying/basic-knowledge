# 锁升级

顺序：偏向锁 -> 轻量级锁 -> 重量级锁

## 偏向锁

指同步代码块一直被同一线程所访问时，即不存在多个线程竞争时，那么后序访问会自动获取偏向锁。

通过 CAS 操作将线程存储到**对象头 mark word**中，记录该线程并设置锁状态为偏向锁(101)。线程加锁和释放锁也不需要再通过 CAS 操作，而是检测对象头中的线程ID是否是当前线程ID。 

> 偏向锁状态下无法获取对象的 hashcode，因为对象的 hashcode 只在无锁状态下存储，会直接转变成重量级锁，hashcode 存储在**MarkOop对象头**中。

## 轻量级锁

轻量级锁又称作**自旋锁**。

当有其他线程加入**锁竞争**时，偏向锁就会转为轻量级锁。

> 锁竞争：当多个线程轮流获取一个锁时，每次获取锁顺利且没有阻塞，就不存在锁竞争。只有当某个线程获取锁时发现锁已经被占用，只能等待释放，这才发生了锁竞争。

在轻量级锁下，没有抢到锁的线程会以**自旋**的方式获取锁。获取锁通过 CAS 操作修改对象头中的**锁标志位**。

# 重量级锁

当自选操作超过**10**次时，认为锁竞争很激烈，这时候将轻量级锁转为重量级锁。当后续进程尝试获取锁时，若被占用的锁是重量级锁，则将自己挂起而不是忙等。

通过对象监视器 monitor 获取锁，monitor enter 抢占锁，抢占失败也会采用**自旋**的方式获取锁，自选失败后加入等待队列，等待持有锁的进程 monitor exist 释放锁，再唤醒阻塞队列的线程。