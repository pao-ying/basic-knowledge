# 定义

进程一般指一个执行单元，在移动设备上就是一个程序或应用，我们在Android中所说的多进程（**IPC**）**一般指一个应用包含多个进程**。

之所以要使用多进程有两方面原因：

- 某些模块由于特殊的需求要运行在单独的进程；
- 增加应用可用的内存空间。

# 引发的问题

- 静态成员和单例模式失效
- 线程同步机制失效

> 对于前两个问题，可以这么理解：
>
> 在Android中，系统会为每个应用或进程分配独立的虚拟机，不同的虚拟机自然占有不同的内存地址空间，所以同一个类的对象会产生不同的副本，导致共享数据失败，必然也不能实现线程的同步。

- SharedPreferences 可靠性降低

> 由于`SharedPreferences`底层采用读写XML的文件的方式实现，多进程并发的的读写很可能导致数据异常。

- Application 被多次创建

> 系统在分配多个虚拟机时相当于把同一个应用重新启动多次，必然会导致 Application 多次被创建。
>
> 为了防止在 Application
> 中出现无用的重复初始化，可使用进程名来做过滤，只让指定进程的才进行全局初始：
>
> ```java
> public class MyApplication extends Application{
>     @Override
>     public void onCreate() {
>         super.onCreate();
>         String processName = "com.shh.ipctest";
>         if (getPackageName().equals(processName)){
>             // do some init
>         }
>     }
> }
> ```

# 多进程通信方式

- AIDL

  功能强大，支持进程间一对多的实时并发通信，并可实现 RPC (远程过程调用)。

- Messenger

  支持一对多的串行实时通信， AIDL 的简化版本。

- Bundle

  四大组件的进程通信方式，只能传输 Bundle 支持的数据类型。

  可传递**基本类型**、**String**、**实现了Serializable或Parcelable接口的数据结构**。

- ContentProvider

  强大的数据源访问支持，主要支持 CRUD 操作，一对多的进程间数据共享，例如我们的应用访问系统的通讯录数据。

- BroadcastReceiver

  即广播，但只能单向通信，接收者只能被动的接收消息。

- 文件共享

  在非高并发情况下共享简单的数据。

  对同一个文件先后写读，从而实现传输，Linux机制下，可以对文件并发写，所以要注意同步。顺便一提，Windows下不支持并发读或写。

- Socket

  通过网络传输数据。

# Messenger(基于 Binder)

Messenger是基于AIDL实现的，通过Message对象进行跨进程通信，类似于Handler发送消息实现线程间通信。服务端（被动方）提供一个Service来处理客户端（主动方）连接，维护一个Handler来创建Messenger，在onBind时返回Messenger的binder。

双方**用Messenger来发送数据，用Handler来处理数据**。Messenger处理数据依靠Handler，所以是串行的，也就是说，Handler接到多个message时，就要排队依次处理。

与 AIDL 比较：

- 当需要执行 IPC 时，为接口使用 Messenger 要比使用 AIDL 实现更加简单，因为 Messenger 会将所有服务调用排入队列，而纯粹的 AIDL 接口会同时向服务发送多个请求，服务随后必须应对多线程处理。
- 对于大多数应用，服务不需要执行多线程处理，因此使用 Messenger 可让服务一次处理一个调用。如果服务必须执行多线程处理，则应使用 AIDL 来定义接口。

# AIDL

AIDL：Android Interface Definition Language，即Android接口定义语言。可以利用它定义客户端与服务使用进程间通信 (IPC) 进行相互通信时都认可的编程接口。

从某种意义上说AIDL其实是一个模板，因为在使用过程中，实际起作用的并不是AIDL文件，而是据此而生成的一个IInterface的实例代码，AIDL其实是为了避免我们重复编写代码而出现的一个模板。

AIDL支持的数据类型

- 基本数据类型（int、long、char、boolean、double、byte、short、float）
- String 和 CharSequence
- List、Map集合：
   List/Map中的所有元素都必须是以上列表中支持的数据类型、其他 AIDL 生成的接口或声明的可打包类型。可选择将 List/Map 用作“通用”类（例如，List<String>、Map<String,Integer>）。
   另一端实际接收的具体类始终是 ArrayList/HashMap，但生成的方法使用的是 List/Map 接口。
- 实现了 Parcelable 接口的对象
- AIDL本身接口也可以在AIDL文件使用