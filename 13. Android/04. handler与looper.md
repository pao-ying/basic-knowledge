`Looper` ， `Handler`和`HandlerThread`是Android解决**异步编程问题**的方法。

# Android 消息机制

## 组件

- 主线程（UI线程）

  1. 定义

     当程序第一次启动时，Android会同时启动一条主线程（Main Thread）

  2. 作用

     主线程主要负责处理与UI相关的事件

- Message （消息）

  1. 定义

     Handler接收和处理的消息对象（Bean对象）

  2. 作用

     通信时相关信息的存放和传递

- ThreadLocal

  1. 定义

     线程内部的数据存储类

  2. 作用

     负责存储和获取本线程的Looper

- Message Queue （消息队列）

  1. 定义

     采用单链表的数据结构来存储消息列表

  2. 作用

     用来存放通过Handler发过来的Message，按照先进先出执行

- Handler （处理者）

  1. 定义

     Message的主要处理者

  2. 作用

     负责发送Message到消息队列&处理Looper分派过来的Message

- Looper （循环器）

  1. 定义

     扮演Message Queue和Handler之间桥梁的角色

  2. 作用

     - 消息循环

       循环取出Message Queue的Message

     - 消息派发

       将取出的Message交付给相应的Handler

## 关系

![img](..\img\20161129232344072)

Looper 中存放有 MessageQueue，MessageQueue 中有很多 Message。

当 Handler 发送消息时，会获取当前的 Looper，并在当前的 Looper 的 MessageQueue 当中存放我们发送的消息，而我们的 MessageQueue 会在 Looper 的带动下，一直循环读取 Message 信息，并将 Message 信息发送给 Handler，并执行 HandlerMessage() 方法

## Looper

### 为什么 Handler 可以在主线程使用

因为主线程（UI线程）的Looper在应用程序开启时创建好了，即在ActivityThread.main方法中创建的，该函数为Android应用程序的入口

### 主要方法

- Looper.prepareMainLooper()

  该方法是 Looper 对象的初始化

- Looper.loop()

  该方法会循环取出 Message Queue 中的 Message，将取出的 Message 交付给 对应的 Handler。

## MessageQueue

### 如何存储 Message

由于Handler使用Post()方法将Message传递到MessageQueen中，在MessageQueen中会使用enqueueMessage()方法存储Message，其实现的方式是通过单链表的数据结构来存储消息列表

### 过程

- 首先判断消息队列里有没有消息，没有的话则将当前插入的消息作为队头，并且这时消息队列如果处于等待状态的话则将其唤醒
- 若是在中间插入，则根据Message创建的时间进行插入

### 消息出去的方法

消息就是在Looper中取出的，其实现是用MessageQueen里面的next()方法

## Handler

### 创建

Handler的创建会关联一个Looper对象，而Looper对象是关联着MessageQueen对象，所以在Handler创建时候，取出Looper和MessageQueen

### 发送消息

- sendMessage(Message msg)
- post(Runnable r)

### 处理消息

调用 Handler 中的 dispatchMessage()