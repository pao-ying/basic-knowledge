# 分库分表

## 垂直划分

### 垂直分库

垂直分库就是根据业务耦合性，将关联度低的不同表存储在不同的数据库。

思想与“微服务治理”类似，将系统拆分为**多个业务**，每个业务使用自己单独的数据库。

### 垂直分表

垂直分表是基于数据库中的表字段来进行的，将某些不常用的，但是长度又很大的字段拎出来放到另外一张表。

> MySQL底层是通过数据页存储的，一条记录占用空间过大会导致跨页，造成额外的**性能开销**。另外数据库以行为单位将数据加载到内存中，这样表中字段长度较短且访问频率较高，内存能加载更多的数据，命中率更高，减少了磁盘IO，从而提升了数据库性能。

### 优点

1. 不同系统可以使用不同的库表，解决业务系统层面的**耦合**，业务清晰；
2. **高并发**场景下，垂直切分一定程度地提升IO、数据库连接数，缓解单机硬件资源的瓶颈。

### 缺点

- 部分查询需要在业务代码逻辑里面做**聚合**，增加开发复杂度；
- **事务**处理复杂，可能需要在业务代码层面做处理；
- 不能**根本**解决单表数据量过大的问题。

## 水平划分

### 库内分表

库内分表就是在同一个DB上，将表按照某种条件拆分为多张表。

> 比如一张订单表，我们可以依据订单的日期，按月建表。一月份的订单放month_201901这张表，二月份的订单放month_201902这张表。

库内分表只解决单表数据量过大问题，但没有将表分布到不同机器上，**所有请求还是在一台物理机上竞争cpu、内存、IO**，对于减轻mysql负载压力来说帮助不大。

### 分库分表

分库分表就是将表不仅拆分，而且拆分到不同机器上。

> 比如我们腾讯云上的DCDB就是这种处理方法。可以指定一张表的shardKey，然后对shardKey取hash，根据hash值将数据放到不同的数据库中，**可以解决单机物理资源的瓶颈问题**。	

### 优点

- 不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力；
- 应用端改造较小，不需要拆分业务模块。

### 缺点

- **事务一致性问题**

  当更新内容同时分布在不同库中，不可避免会带来跨库事务问题。一般使用“XA协议”与“两阶段提交”处理。

- **跨节点关联查询 join 问题**

  考虑到性能，尽量避免使用 Join。

  解决方法：

  - **全局表**

    将每个模块依赖的表在每个数据库中保存一份（这些数据很少修改），这样就可以避免跨库JOIN。

  - **字段冗余**

    反范式设计，利用空间换时间，为了性能而避免join查询。

    > 订单表保存userId时候，也将userName冗余保存一份，这样查询订单详情时就不需要再去查询”买家user表”了

  - 数据组装

    在系统层面，分两次查询，第一次查询的结果集中找出关联数据id，然后根据id发起第二次请求得到关联数据，最后将获得到的数据进行字段拼装。

### 跨节点分页、排序、函数问题

在跨节点多库查询时，会出现limit分页、order by排序等问题。

分页需要按照指定字段进行排序，当**排序字段就是分片字段**时，通过分片规则就比较容易定位到指定的分片。

当排序字段非分片字段时，就变得比较复杂了。需要先在不同的分片节点中将数据进行排序并返回，然后将不同分片返回的结果集进行汇总和再次排序，最终返回给用户。显然这个过程是会降低查询的效率，对IO，CPU也会增加额外负担。
