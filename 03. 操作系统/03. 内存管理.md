# 内存管理方式

## 连续分配管理方式

为一个用户进程分配一个连续的内存空间

- 块式存储

  将内存分为固定大小的几块，程序需要内存时就分配一块。会产生很多的**碎片**。

## 非连续分配管理方式

允许一个程序使用的	内存分布在离散的内存中

- 页式存储

  将主存大小分为相等的一页一页的形式，页较小，更好管理。

  页式管理通过**页表**对应逻辑地址和物理地址

- 段式存储

  页式存储中的页没有实际意义。段式存储将内存分为一段一段的，每一段要比一页小很多。重要的是段是有实际意义的，每一个段定义了**一组逻辑信息**。如主程序段、子程序段等。

  段式存储通过**段表**对应逻辑地址和物理地址

- 段页式存储

  将内存分为一段一段的，再将每个段分为若干页。

分页和分段共同点和区别

- 共同点
  1. 提供内存利用率，减少碎片
  2. 离散存储
- 区别
  1. 页的大小固定，段的大小取决于运行的程序
  2. 段有实际意义，每个段定义了一组逻辑信息

# 缺页中断

当 CPU 访问的页面不在物理内存时，便会产生一个缺页中断，请求操作系统将所缺页调入到物理内存。

## 流程

<img src="..\img\缺页异常流程.png" alt="缺页中断的处理流程" style="zoom:50%;" />

## 页表

![img](..\img\页表项字段.png)

- ***状态位***：用于表示该页是否有效，也就是说是否在物理内存中，供程序访问时参考。
- ***访问字段***：用于记录该页在一段时间被访问的次数，供页面置换算法选择出页面时参考。
- ***修改位***：表示该页在调入内存后是否有被修改过，由于内存中的每一页都在磁盘上保留一份副本，因此，如果没有修改，在置换该页时就不需要将该页写回到磁盘上，以减少系统的开销；如果已经被修改，则将该页重写到磁盘上，以保证磁盘中所保留的始终是最新的副本。
- ***硬盘地址***：用于指出该页在硬盘上的地址，通常是物理块号，供调入该页时使用。

# 虚拟内存流程

<img src="..\img\虚拟内存管理流程.png" alt="虚拟内存的流程" style="zoom: 33%;" />

# 快表和多级页表

## 多级页表

多级页表就是**页目录表+页表**，页目录表的每一项对应一个页表，然后再根据页表找到对应的页。

避免将全部的页表都放入内存中，占用过多空间，而不需要的页表也在内存中占用不必要的空间。

**缺点**

每次都需要通过多级页表找到具体的页，也就是需要**三次访问内存**。因为CPU每条指令的时间大部分花费在访问内存上，CPU执行速度是很快的。所以虽然多级页表可以节省内存，但是时间上花费是要更多的。

## 快表 TLB

快表用于存储**最近访问的页**，CPU需要访问某一页首先在TLB里面找，如果TLB里面有就不用访问内存了，因为TLB是**寄存器**，cpu访问寄存器的速度远大于对内存的访问速度。这样就可以提升时间性能了。

为了解决虚拟地址到物理地址的转换速度，类似于缓存，其中的内容是也页表的一部分内容或者全部内容。

https://blog.csdn.net/williamgavin/article/details/83240402

# CPU寻址

CPU寻址就是为了**将虚拟地址转换为物理地址**，才能访问到真实的物理内存。

> 因为不能直接把物理地址空间暴漏给应用程序，所以使用虚拟地址空间间接访问。

## 指令寻址

### 顺序寻址方式

由于指令地址在内存中按顺序安排，当执行一段程序时，通常是一条指令接一条指令地顺序进行。这种程序顺序执行的过程，称为指令的顺序寻址方式。

> 使用程序计数器PC来计数指令的顺序号，该顺序号就是指令在内存中的地址。

### 跳跃寻址方式

当程序转移执行的顺序时，指令的寻址就采取跳跃寻址方式。**跳跃**，就是指令的的地址码不是由程序计数器给出，而是由本条指令给出。

> 采用指令跳跃寻址方式，可以实现程序转移或构成循环程序，从而能缩短程序长度，或将某些程序作为公共程序引用(方法或函数)。

## 操作数寻址

### 隐含寻址

这种类型的指令，不是明显地给出操作数的地址。而是在**指令中隐含着操作数的地址**。单地址的指令格式，就不明显地在地址字段中指出第2操作数的地址，而是规定**累加寄存器AC**作为第2操作数地址。因此，[累加寄存器](https://baike.baidu.com/item/累加寄存器/3219636)AC对单地址指令格式来说是隐含地址。

### 立即寻址

指令的地址字段指出的不是操作数的地址，而是操作数本身，这种寻址方式称为立即寻址。

### 直接寻址

直接寻址是一种基本的寻址方法，其特点是：在指令格式的地址的字段中直接指出操作数在内存的地址。

### 间接寻址

间接寻址是相对直接寻址而言的，在间接寻址的情况下，指令地址字段中的形式地址不是操作数的真正地址，而是操作数地址的指示器，或者说此形式地址单元的内容才是操作数的有效地址。

### 相对寻址方式

相对寻址是把程序计数器PC的内容加上指令格式中的形式地址D而形成操作数的有效地址。“相对”寻址，就是相对于当前的指令地址而言。采用相对寻址方式的好处是程序员无须用指令的绝对地址编程，因而所编程序可以放在内存的任何地方。

## 逻辑地址

逻辑地址就是**操作系统或应用程序面对的存储单元地址的表示形式**。分段存储管理方式把内存划分为多个逻辑段（代码段、数据段、堆栈段等），从而把不同的数据存储隔离开。逻辑地址使用**段号：偏移地址**的形式描述数据地址。

1. 逻辑地址面向上层的程序员的。
2. 逻辑地址不一定是真实的物理地址，即数组元素的物理地址(在内存条中所处的位置)，并非是连续的，只是操作系统通过地址映射，将逻辑地址映射成连续的，这样更符合人们的直观思维。
3. **逻辑地址只是一个描述形式，cpu真正用来寻址的是虚拟地址，而虚拟地址是用逻辑地址形式描述的**

# 虚拟内存

## 描述

虚拟内存可以让程序拥有超过系统物理内存大小的内存可用空间，同时虚拟内存可以为每一个进程提供一个私有的地址空间，让每一个进程产生一种拥有一片连续完整的内存空间的错觉。这样可以进行有效管理和减少出错。

同时可以防止多进程数据操作越界的问题。

就是在硬盘空间上重新定义了一个**连续的虚拟地址空间**

https://blog.csdn.net/shellquery/article/details/100893040

## 技术实现

实现虚拟内存到物理内存的映射

- 请求分页式存储
- 请求分段式存储
- 请求段页式存储

## 页面置换算法

当发生**缺页中断**时，即当前内存中没有空闲的页面，操作系统就必须选择一个页面将其移除，用来淘汰哪一页的规则就叫做页面置换算法。

- OPT页面置换算法（最佳页面置换算法）

  从内存中移除不再需要的页面，如果没有这样的页面，则**移除最长时间不需要访问**的页面。

- FIFO（先进先出页面置换算法）：淘汰最先进入内存的页面，即选择驻留时间最长的淘汰

- LRU（最近最久未使用）

- LFU（最近最少使用）